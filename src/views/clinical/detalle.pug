extends ../layouts/main

block content
  // --- HEADER DE NAVEGACI√ìN ---
  div(class="max-w-6xl mx-auto mb-8")
    div(class="flex flex-col md:flex-row md:items-end justify-between gap-6")
      div
        h2(class="text-xs font-bold text-indigo-500 dark:text-purple-400 mb-1 tracking-widest uppercase") Historia Cl√≠nica Digital
        h1(class="text-3xl md:text-4xl font-bold tracking-tight text-slate-900 dark:text-white")
          | Paciente <span class="text-indigo-600 dark:text-purple-500">#{internacion.Paciente.nombre} #{internacion.Paciente.apellido}</span>
      
      div(class="flex gap-3")
        a(href="/clinica/dashboard" class="px-5 py-2.5 rounded-xl border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 font-bold transition-colors text-sm flex items-center gap-2")
          span &larr;
          | Volver

  // --- TARJETA DE PACIENTE (INFO PRINCIPAL) ---
  div(class="max-w-6xl mx-auto bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-[2rem] shadow-sm overflow-hidden mb-10")
    div(class="p-8 md:p-10")
      div(class="flex flex-col lg:flex-row gap-8 lg:items-start")
        
        // 1. Avatar y Datos B√°sicos
        div(class="flex items-start gap-5 flex-1")
          - let avatarBg = internacion.Paciente.sexo === 'F' ? 'bg-rose-100 text-rose-600 dark:bg-rose-900/50 dark:text-rose-300' : 'bg-blue-100 text-blue-600 dark:bg-blue-900/50 dark:text-blue-300'
          div(class=`w-20 h-20 rounded-3xl flex items-center justify-center text-3xl font-bold shrink-0 ${avatarBg}`)
            | #{internacion.Paciente.nombre.charAt(0)}#{internacion.Paciente.apellido.charAt(0)}
          
          div
            h2(class="text-2xl font-bold text-slate-900 dark:text-white leading-tight mb-1") #{internacion.Paciente.nombre} #{internacion.Paciente.apellido}
            div(class="flex flex-wrap gap-2 mb-3")
              span(class="px-2.5 py-0.5 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs font-bold font-mono") DNI: #{internacion.Paciente.dni}
              span(class="px-2.5 py-0.5 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs font-bold") #{Math.floor((new Date() - new Date(internacion.Paciente.fecha_nacimiento)) / 31557600000)} A√±os
            
            p(class="text-sm text-slate-500 dark:text-slate-400 leading-relaxed")
              span(class="font-bold uppercase text-[10px] tracking-wider text-slate-400 dark:text-slate-500 block mb-1") Motivo de Ingreso
              | "#{internacion.motivo}"

        // 2. Ubicaci√≥n y Estado
        div(class="flex flex-col gap-4 min-w-[200px] border-l border-slate-100 dark:border-slate-700 pl-0 lg:pl-8")
           div
             span(class="text-[10px] font-bold uppercase tracking-wider text-slate-400 block mb-1") Ubicaci√≥n Actual
             div(class="flex items-center gap-3")
               div(class="text-3xl") üè•
               div
                 p(class="text-sm font-bold text-slate-900 dark:text-white") Habitaci√≥n #{internacion.Cama.Habitacion ? internacion.Cama.Habitacion.numero : 'N/A'}
                 p(class="text-xs text-slate-500 dark:text-slate-400") Cama #{internacion.Cama.numero_cama}
           
           div
             span(class="text-[10px] font-bold uppercase tracking-wider text-slate-400 block mb-1") Estado
             span(class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 text-xs font-bold")
                span(class="w-2 h-2 rounded-full bg-emerald-500 mr-2 animate-pulse")
                | Internado / Activo

    // Barra de Acciones (Footer de la tarjeta)
    div(class="bg-slate-50 dark:bg-slate-900/50 px-8 py-4 border-t border-slate-200 dark:border-slate-700 flex flex-wrap gap-3 justify-end")
       // Bot√≥n Enfermer√≠a
       a(href=`/enfermeria/evaluar/${internacion.id}` class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-teal-600 hover:bg-teal-700 text-white font-bold text-sm shadow-md transition-all hover:-translate-y-0.5")
          span ü©∫
          | Signos Vitales
       
       // Bot√≥n M√©dico
       a(href=`/medico/evolucionar/${internacion.id}` class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-sm shadow-md transition-all hover:-translate-y-0.5")
          span üë®‚Äç‚öïÔ∏è
          | Evoluci√≥n M√©dica

  // --- SECCI√ìN: NOTA R√ÅPIDA (AJAX) ---
  div(class="max-w-4xl mx-auto mb-12")
    div(class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-1 shadow-sm flex gap-2")
      form(id="formAjax" class="w-full flex gap-2")
        input(type="hidden" name="internacion_id" value=internacion.id)
        // Detecci√≥n autom√°tica de rol para el tipo de nota
        input(type="hidden" name="tipo" value=usuario.rol === 'Enfermeria' ? 'Enfermeria' : 'Medico')
        
        input(type="text" id="inputNota" name="nota" placeholder="Escribe una evoluci√≥n r√°pida y presiona Enter..." class="flex-1 px-4 py-3 bg-transparent border-none focus:ring-0 text-slate-800 dark:text-white placeholder-slate-400 outline-none" required autocomplete="off")
        
        button(type="submit" class="bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-6 rounded-xl font-bold text-sm hover:opacity-90 transition-opacity")
          | Enviar

  // --- L√çNEA DE TIEMPO ---
  div(class="max-w-4xl mx-auto")
    div(class="flex items-center gap-4 mb-8")
       div(class="h-px flex-1 bg-slate-200 dark:bg-slate-700")
       h3(class="text-sm font-bold text-slate-400 uppercase tracking-widest") Historial Cl√≠nico
       div(class="h-px flex-1 bg-slate-200 dark:bg-slate-700")

    // Contenedor Timeline
    div(id="timelineContainer" class="space-y-8 relative before:absolute before:inset-0 before:ml-5 before:-translate-x-px md:before:mx-auto md:before:translate-x-0 before:h-full before:w-0.5 before:bg-slate-200 dark:before:bg-slate-700")
      
      if internacion.Evolucions.length === 0
         div(class="text-center py-12 relative bg-white dark:bg-slate-800 rounded-2xl border border-dashed border-slate-300 dark:border-slate-600 z-10")
            p(class="text-slate-400") No hay evoluciones registradas a√∫n.
      
      else
         each evo in internacion.Evolucions
            - const esMedico = evo.tipo === 'Medico'
            - const colorBorde = esMedico ? 'border-indigo-500' : 'border-teal-500'
            - const colorIcono = esMedico ? 'bg-indigo-100 text-indigo-600 dark:bg-indigo-900 dark:text-indigo-300' : 'bg-teal-100 text-teal-600 dark:bg-teal-900 dark:text-teal-300'
            - const icono = esMedico ? 'üë®‚Äç‚öïÔ∏è' : 'ü©∫'
            - const titulo = esMedico ? 'M√©dico' : 'Enfermer√≠a'

            div(class="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group")
              
              // ICONO CENTRAL
              div(class=`flex items-center justify-center w-10 h-10 rounded-full border-4 border-white dark:border-slate-900 ${colorIcono} shadow-sm shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 z-10`)
                span(class="text-sm") #{icono}
              
              // TARJETA DE CONTENIDO
              div(class=`w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 border-l-4 ${colorBorde} hover:shadow-md transition-shadow`)
                
                // Header Nota
                div(class="flex justify-between items-center mb-3")
                  span(class=`text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide ${esMedico ? 'bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300' : 'bg-teal-50 text-teal-700 dark:bg-teal-900/30 dark:text-teal-300'}`) #{titulo}
                  span(class="text-xs text-slate-400 font-mono") #{new Date(evo.createdAt).toLocaleString()}
                
                // Texto Nota
                div(class="text-slate-700 dark:text-slate-300 text-sm leading-relaxed mb-4")
                  | #{evo.nota}

                // Signos Vitales (Grid Mini)
                if evo.signos_vitales
                   div(class="grid grid-cols-3 gap-2 pt-3 border-t border-slate-100 dark:border-slate-700")
                      if evo.signos_vitales.presion
                        div(class="text-center")
                          span(class="block text-[10px] text-slate-400 uppercase") Presi√≥n
                          span(class="font-bold text-slate-700 dark:text-white font-mono") #{evo.signos_vitales.presion}
                      if evo.signos_vitales.temperatura
                        div(class="text-center")
                          span(class="block text-[10px] text-slate-400 uppercase") Temp.
                          span(class="font-bold text-slate-700 dark:text-white font-mono") #{evo.signos_vitales.temperatura}¬∞
                      if evo.signos_vitales.frecuencia_cardiaca
                        div(class="text-center")
                          span(class="block text-[10px] text-slate-400 uppercase") Pulso
                          span(class="font-bold text-slate-700 dark:text-white font-mono") #{evo.signos_vitales.frecuencia_cardiaca}

                // Autor Footer
                div(class="mt-3 pt-2 text-right")
                   p(class="text-xs font-bold text-slate-400 dark:text-slate-500") Por: #{evo.Autor ? evo.Autor.nombre : 'Desconocido'}

  // --- SCRIPT AJAX ---
  script.
    const form = document.getElementById('formAjax');
    const container = document.getElementById('timelineContainer');
    const input = document.getElementById('inputNota');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = {
        internacion_id: form.internacion_id.value,
        tipo: form.tipo.value,
        nota: input.value
      };

      try {
        const response = await fetch('/api/evolucion', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        const result = await response.json();

        if (result.success) {
          const evo = result.data;
          const esMedico = evo.tipo === 'Medico';
          const colorBorde = esMedico ? 'border-indigo-500' : 'border-teal-500';
          const colorIcono = esMedico ? 'bg-indigo-100 text-indigo-600 dark:bg-indigo-900 dark:text-indigo-300' : 'bg-teal-100 text-teal-600 dark:bg-teal-900 dark:text-teal-300';
          const icono = esMedico ? 'üë®‚Äç‚öïÔ∏è' : 'ü©∫';
          const titulo = esMedico ? 'M√©dico' : 'Enfermer√≠a';
          const badgeClass = esMedico ? 'bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300' : 'bg-teal-50 text-teal-700 dark:bg-teal-900/30 dark:text-teal-300';

          const nuevoHtml = `
            <div class="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group animate-pulse">
              <div class="flex items-center justify-center w-10 h-10 rounded-full border-4 border-white dark:border-slate-900 ${colorIcono} shadow-sm shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 z-10">
                <span class="text-sm">${icono}</span>
              </div>
              <div class="w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 border-l-4 ${colorBorde}">
                <div class="flex justify-between items-center mb-3">
                  <span class="text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide ${badgeClass}">${titulo}</span>
                  <span class="text-xs text-slate-400 font-mono">Ahora mismo</span>
                </div>
                <div class="text-slate-700 dark:text-slate-300 text-sm leading-relaxed mb-4">
                  ${evo.nota}
                </div>
                <div class="mt-3 pt-2 text-right">
                   <p class="text-xs font-bold text-slate-400 dark:text-slate-500">Por: ${evo.Autor.nombre}</p>
                </div>
              </div>
            </div>
          `;
          
          // Remover mensaje de vac√≠o si existe
          const emptyMsg = container.querySelector('.text-center.py-12');
          if(emptyMsg) emptyMsg.remove();

          container.insertAdjacentHTML('afterbegin', nuevoHtml);
          input.value = '';
        } else {
          alert('Error: ' + result.error);
        }
      } catch (err) {
        console.error(err);
        alert('Error de conexi√≥n');
      }
    });