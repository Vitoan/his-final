extends ../layouts/main

block content
  div(class="grid grid-cols-1 md:grid-cols-2 gap-4")
    // Columna Izquierda: Datos Paciente
    div(class="bg-white p-4 rounded shadow")
      h2(class="text-xl font-bold text-slate-700") Paciente: #{paciente.nombre}
      p(class="text-sm") Estado: #{internacion.estado}
      
      // Botón de Cancelación (Requisito "Arrepentimiento/Error")
      if usuario.rol === 'Admision' || usuario.rol === 'Admin'
        button(onclick="cancelarInternacion(" + internacion.id + ")" class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs mt-2") Cancelar Internación (Error de Carga)

    // Columna Derecha: Evoluciones (AJAX)
    div(class="bg-white p-4 rounded shadow")
      h3(class="font-bold mb-2") Historial Clínico
      
      // Lista de evoluciones (Se llena dinámicamente o carga inicial)
      div#lista-evoluciones(class="h-64 overflow-y-auto border p-2 mb-2 bg-slate-50")
        each ev in evoluciones
          div(class=`mb-2 p-2 rounded ${ev.tipo === 'Medico' ? 'bg-blue-100' : 'bg-green-100'}`)
            small(class="font-bold") #{ev.tipo} - #{new Date(ev.createdAt).toLocaleString()}
            p #{ev.nota}

      // Formulario AJAX
      form#form-evolucion
        input(type="hidden" name="internacion_id" value=internacion.id)
        textarea(id="txtNota" class="w-full border p-2 rounded" placeholder="Escriba la evolución..." required)
        
        // Si es enfermería, mostrar inputs de signos vitales
        if usuario.rol === 'Enfermeria'
           div(class="flex gap-2 mt-2")
             input(id="txtPresion" placeholder="Presión (120/80)" class="border p-1 rounded w-1/2")
             input(id="txtTemp" placeholder="Temp (36.5)" class="border p-1 rounded w-1/2")

        button(type="submit" class="mt-2 bg-teal-600 text-white px-4 py-2 rounded w-full") Agregar Nota

  // SCRIPT AJAX
  script.
    document.getElementById('form-evolucion').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const nota = document.getElementById('txtNota').value;
      const presion = document.getElementById('txtPresion') ? document.getElementById('txtPresion').value : null;
      const internacionId = '#{internacion.id}'; // Variable de PUG
      
      try {
        const response = await fetch('/api/evoluciones', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ internacion_id: internacionId, nota, presion })
        });
        
        if(response.ok) {
          const data = await response.json();
          // Agregar al DOM sin recargar
          const lista = document.getElementById('lista-evoluciones');
          const div = document.createElement('div');
          div.className = data.tipo === 'Medico' ? 'bg-blue-100 mb-2 p-2 rounded' : 'bg-green-100 mb-2 p-2 rounded';
          div.innerHTML = `<small class="font-bold">${data.tipo} - Ahora</small><p>${data.nota}</p>`;
          lista.prepend(div);
          document.getElementById('form-evolucion').reset();
        }
      } catch (err) {
        alert('Error guardando evolución');
      }
    });

    async function cancelarInternacion(id) {
        if(!confirm('¿Seguro que desea cancelar esta internación por error de carga?')) return;
        // Fetch a ruta de cancelación...
    }